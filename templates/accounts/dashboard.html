{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - TVET Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Welcome, {{ user.get_full_name|default:user.username }}!</h2>
        <p class="lead">Computerized Attendance and Class Management System for TVET Institutions in Kitui County</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Active Students</h5>
                        <h2 class="mb-0">{{ total_students|default:0 }}</h2>
                        <small>Male: {{ male_students|default:0 }} | Female: {{ female_students|default:0 }}</small>
                    </div>
                    <i class="fas fa-users fa-3x opacity-50"></i>
                </div>
                <a href="{% url 'students:list' %}" class="stretched-link"></a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Courses & Classes</h5>
                        <h2 class="mb-0">{{ total_courses|default:0 }}</h2>
                        <small>{{ total_classes|default:0 }} Active Classes</small>
                    </div>
                    <i class="fas fa-book fa-3x opacity-50"></i>
                </div>
                <a href="{% url 'courses:list' %}" class="stretched-link"></a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-warning h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Today's Attendance</h5>
                        <h2 class="mb-0">{{ today_attendance|default:0 }}</h2>
                        <small>Present: {{ today_present|default:0 }} | Late: {{ today_late|default:0 }}</small>
                    </div>
                    <i class="fas fa-check-circle fa-3x opacity-50"></i>
                </div>
                <a href="{% url 'attendance:report' %}?date=today" class="stretched-link"></a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-info h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Instructors</h5>
                        <h2 class="mb-0">{{ total_instructors|default:0 }}</h2>
                        <small>Active Faculty Members</small>
                    </div>
                    <i class="fas fa-chalkboard-teacher fa-3x opacity-50"></i>
                </div>
                {% if request.user.user_type == 'admin' or request.user.is_superuser %}
                <a href="{% url 'courses:manage_instructor_assignments' %}" class="stretched-link"></a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- User-specific additional stats -->
{% if user.user_type == 'student' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>My Attendance Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>Total Sessions</h6>
                            <h3>{{ my_attendance|default:0 }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>Present</h6>
                            <h3 class="text-success">{{ my_present|default:0 }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>Attendance Rate</h6>
                            <h3 class="text-primary">
                                {% if my_attendance and my_attendance > 0 %}
                                    {{ my_present|floatformat:0|default:0 }}%
                                {% else %}0%{% endif %}
                            </h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'attendance:student_history' %}" class="btn btn-outline-info w-100">
                            <i class="fas fa-history me-2"></i>View Full History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Department Distribution (for admin) -->
{% if user.user_type == 'admin' or user.is_superuser or user.user_type == 'registrar' or user.user_type == 'hod' %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Top Departments by Courses</h5>
            </div>
            <div class="card-body">
                {% if top_departments %}
                <div class="list-group">
                    {% for dept in top_departments %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        {{ dept.department|default:"Uncategorized" }}
                        <span class="badge bg-primary rounded-pill">{{ dept.count }} courses</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No departments data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Attendance Records
                        <span class="badge bg-primary rounded-pill">{{ total_attendance_records|default:0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Present Marks
                        <span class="badge bg-success rounded-pill">{{ total_present|default:0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Today's Attendance Rate
                        <span class="badge bg-info rounded-pill">{{ attendance_rate|default:0 }}%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Active Sessions Now
                        <span class="badge bg-warning rounded-pill">{{ active_sessions_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Students
                        <span class="badge bg-primary rounded-pill">{{ total_students|default:0 }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Active Attendance Sessions Section -->
{% if active_sessions_count > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle me-2"></i>
                    Active Attendance Sessions
                    <span class="badge bg-light text-primary ms-2">{{ active_sessions_count }} Active</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Current/First Active Session -->
                    {% if active_session %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i> Current Session
                                </h6>
                                <span class="badge bg-light text-success">Ongoing</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">{{ active_session.class_session.course.name }}</h5>
                                <p class="mb-2">
                                    <strong>Course Code:</strong> {{ active_session.class_session.course.code }}<br>
                                    <strong>Class:</strong> {{ active_session.class_session.class_code }}<br>
                                    <strong>Instructor:</strong> {{ active_session.instructor.get_full_name|default:active_session.instructor.username }}
                                </p>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <small class="text-muted d-block">Date</small>
                                            <strong>{{ active_session.session_date|date:"M d, Y" }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-2 text-center">
                                            <small class="text-muted d-block">Time</small>
                                            <strong>{{ active_session.start_time|time:"H:i" }} - {{ active_session.end_time|time:"H:i" }}</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Attendance Statistics -->
                                <div class="row mb-3">
                                    <div class="col-4">
                                        <div class="text-center">
                                            <span class="badge bg-success rounded-pill p-2">Present</span>
                                            <h5 class="mt-2">{{ active_session.total_present }}</h5>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <span class="badge bg-danger rounded-pill p-2">Absent</span>
                                            <h5 class="mt-2">{{ active_session.total_absent }}</h5>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <span class="badge bg-warning rounded-pill p-2">Late</span>
                                            <h5 class="mt-2">{{ active_session.total_late }}</h5>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-grid gap-2">
                                    <a href="{% url 'attendance:qr_attendance' session_id=active_session.id %}?scan=true" 
                                       class="btn btn-success">
                                        <i class="fas fa-qrcode me-2"></i> Scan QR Attendance
                                    </a>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'attendance:mark_attendance' session_id=active_session.id %}" 
                                           class="btn btn-primary">
                                            <i class="fas fa-pen me-2"></i> Mark Attendance
                                        </a>
                                        <a href="{% url 'attendance:view_qr' session_id=active_session.id %}" 
                                           class="btn btn-info">
                                            <i class="fas fa-eye me-2"></i> View QR Code
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Other Active Sessions -->
                    {% if recent_sessions %}
                    <div class="{% if active_session %}col-md-6{% else %}col-12{% endif %}">
                        <div class="card border-info h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    {% if active_session %}Other Active Sessions{% else %}All Active Sessions{% endif %}
                                </h6>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for session in recent_sessions %}
                                    {% if not active_session or session.id != active_session.id %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">{{ session.class_session.course.name }}</h6>
                                            <small class="text-muted">{{ session.start_time|time:"H:i" }}</small>
                                        </div>
                                        <p class="mb-1">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar-alt me-1"></i>{{ session.session_date|date:"M d, Y" }}
                                                <i class="fas fa-chalkboard-teacher ms-2 me-1"></i>{{ session.class_session.class_code }}
                                            </small>
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <div>
                                                <span class="badge bg-success">P: {{ session.total_present }}</span>
                                                <span class="badge bg-danger">A: {{ session.total_absent }}</span>
                                                <span class="badge bg-warning">L: {{ session.total_late }}</span>
                                            </div>
                                            <div>
                                                <a href="{% url 'attendance:qr_attendance' session_id=session.id %}?scan=true" 
                                                   class="btn btn-sm btn-outline-success me-1"
                                                   title="Scan QR">
                                                    <i class="fas fa-qrcode"></i>
                                                </a>
                                                <a href="{% url 'attendance:mark_attendance' session_id=session.id %}" 
                                                   class="btn btn-sm btn-outline-primary"
                                                   title="Mark Attendance">
                                                    <i class="fas fa-pen"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Active Sessions Message -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-body text-center py-4">
                <i class="fas fa-info-circle fa-3x text-warning mb-3"></i>
                <h5>No Active Attendance Sessions</h5>
                <p class="text-muted mb-3">There are no ongoing attendance sessions at the moment.</p>
                {% if request.user.user_type == 'instructor' or request.user.is_staff %}
                    <a href="{% url 'attendance:create_session' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Create New Session
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- System Information Card -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> System Information</h5>
            </div>
            <div class="card-body">
                <h6>Project Title:</h6>
                <p>Design and Implementation of a Computerized Attendance and Class Management System in TVET Institutions in Kitui County.</p>
                
                <h6>Specific Objectives:</h6>
                <ol>
                    <li>To design and develop a secure computerized system for managing classes and user access.</li>
                    <li>To design and implement a computerized learner registration and attendance marking module.</li>
                    <li>To generate automated attendance reports and visual analytics.</li>
                    <li>To test, deploy, and document the system.</li>
                </ol>
                
                <h6>Developer:</h6>
                <p class="mb-0">
                    <strong>Franciscah Mwende Mutia</strong><br>
                    ADM Number: 2025CS162301<br>
                    Course: CS 7403
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}